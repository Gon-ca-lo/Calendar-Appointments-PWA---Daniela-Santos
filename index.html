<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daniela Santos – Unhas • Estética • Massagem</title>

  <!-- PWA Essentials – always present -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#f8c8dc" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="https://via.placeholder.com/180/f8c8dc/6b2c4f?text=DS">

  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">

  <!-- Scripts – load always, but we control visibility -->
  <script type="module" src="dataManager.js" defer></script>
  <script type="module" src="events.js" defer></script>
  <script type="module" src="script.js" defer></script>

  <style>
    /* Install page styles (only visible before install) */
    #install-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #fff0f5, #ffe4f0);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      z-index: 9999;
      color: #4a2c3a;
    }
    #install-screen.hidden {
      display: none;
    }

    #install-screen h1 {
      font-size: 2.8rem;
      margin: 0 0 16px;
      color: #6b2c4f;
    }
    #install-screen p {
      max-width: 420px;
      margin: 0 24px 32px;
      font-size: 1.2rem;
      line-height: 1.5;
    }

    .install-btn {
      padding: 18px 60px;
      font-size: 1.5rem;
      font-weight: 600;
      background: linear-gradient(135deg, #6b2c4f, #8a3c63);
      color: white;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      box-shadow: 0 12px 40px rgba(107,44,79,0.4);
      transition: all 0.3s;
    }
    .install-btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 60px rgba(107,44,79,0.5);
    }

    .ios-guide {
      margin-top: 32px;
      font-size: 1.1rem;
      color: #5a3f4f;
      line-height: 1.6;
      max-width: 380px;
    }
    .note {
      margin-top: 48px;
      font-size: 0.95rem;
      color: #777;
    }

    /* Hide full app until installed */
    #app-content {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Install screen – shown first time in browser -->
  <div id="install-screen">
    <div class="container">
      <h1>Daniela Santos</h1>
      <p class="subtitle">
        App de marcações e serviços<br>
        <strong>Adiciona à tela inicial para acesso rápido</strong>
      </p>

      <button class="install-btn" id="installBtn">Instalar na Tela Inicial</button>

      <p class="ios-guide hidden" id="iosGuide">
        No iPhone/iPad:<br>
        1. Toca no ícone <strong>Partilhar</strong> ⤴<br>
        2. Escolhe <strong>Adicionar à Tela de Início</strong><br>
        3. Confirma e pronto!
      </p>

      <p class="note">
        Funciona em Android, iPhone, Tablet e Computador.
      </p>
    </div>
  </div>

  <!-- Your full app – hidden until launched as PWA -->
  <div id="app-content">
    <header class="header">
      <div id="info">
        <h1>Daniela Santos</h1>
        <p>Unhas • Estética • Massagem</p>
      </div>

      <div id="controls">
        <div id="weeks">
          <button id="prevWeek">← Semana Anterior</button>
          <button id="nextWeek">Semana Seguinte →</button>
        </div>

        <div id="btns">
          <button id="eventBtn">Marcações</button>
          <button id="serviceBtn">Serviços</button>
        </div>

        <div id="calc">
          <p>€ / €</p>
          <div id="bar"></div>
        </div>
      </div>
    </header>
  </div>

  <main>
    <div id="calendar">
      <div class="col hour">
        <div class="cell hour"></div>
        <div class="cell hour">08:00</div>
        <div class="cell hour">09:00</div>
        <div class="cell hour">10:00</div>
        <div class="cell hour">11:00</div>
        <div class="cell hour">12:00</div>
        <div class="cell hour">13:00</div>
        <div class="cell hour">14:00</div>
        <div class="cell hour">15:00</div>
        <div class="cell hour">16:00</div>
        <div class="cell hour">17:00</div>
        <div class="cell hour">18:00</div>
        <div class="cell hour">19:00</div>
        <div class="cell hour">20:00</div>
      </div>

      <div class="col">
        <div class="cell day">Monday</div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
      </div>
      
      <div class="col">
        <div class="cell day">Tuesday</div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
      </div>

      <div class="col">
        <div class="cell day">Wednesday</div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
      </div>

      <div class="col">
        <div class="cell day">Thursday</div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
      </div>

      <div class="col">
        <div class="cell day">Friday</div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
      </div>

      <div class="col">
        <div class="cell day">Saturday</div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
      </div>

      <div class="col">
        <div class="cell day">Sunday</div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
        <div class="cell event"></div>
      </div>
    </div>
  </main>

  <!-- Event Modal -->
  <div id="eventModal" class="modal">
    <div class="modal-content">
      <span class="closeBtn">&times;</span>
      <h2>Adicionar / Editar Marcação</h2>
      <form id="eventForm">
        <div class="line1">
          <div class="modalCont">
            <label for="service">Serviço</label>
            <input type="text" id="service" name="service" list="serviceSuggestions" placeholder="e.g. Gel Manicure" required>
            <datalist id="serviceSuggestions"></datalist>
          </div>

          <div class="modalCont">
            <label for="eventColor">Cor</label>
            <input type="color" id="eventColor" name="eventColor" value="#f8c8dc">
          </div>
        </div>
  
        <div class="line2">
          <div class="modalCont">
            <label for="client">Cliente</label>
            <input type="text" id="client" name="client" required>
          </div>

          <div class="modalCont">
            <label for="eventPrice">Preço (€)</label>
            <input type="number" id="eventPrice" name="eventPrice" min="0" step="0.01" required>
          </div>
        </div>

        <div class="line3">
          <div class="modalCont">
            <label for="date">Data</label>
            <input type="date" id="date" name="date" required>
          </div>

          <div class="modalCont">
            <label for="start">Começo</label>
            <input type="time" id="start" name="start" min="08:00" max="21:00" required>
          </div>

          <div class="modalCont">
            <label for="end">Final</label>
            <input type="time" id="end" name="end" min="08:00" max="21:00" required>
          </div>
        </div>
              
        <div class="modalBtns">
          <button type="button" id="modalDelete" class="noBtn">Eliminar</button>
          <button type="submit" class="yesBtn">Marcar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Services Modal -->
  <div id="serviceModal" class="modal">
    <div class="modal-content">
      <span class="closeBtn">&times;</span>

      <h2>Templates</h2>

      <div id="templatesList" class="templates-list"></div>

      <div id="servicesList"></div>
      <form id="templateForm">
        <div class="line1">
          <div class="modalCont">
            <label for="templateName">Serviço</label>
            <input type="text" id="templateName" required>
          </div>

          <div class="modalCont">
            <label for="templateColor">Cor</label>
            <input type="color" id="templateColor" value="#f8c8dc">
          </div>
        </div>

        <div class="line2">
          <div class="modalCont">
            <label for="templatePrice">Preço (€)</label>
            <input type="number" id="templatePrice" min="0" step="0.01" required>
          </div>
        </div>

        <div class="modalBtns">
          <button type="button" class="noBtn">Apagar</button>
          <button type="submit" class="yesBtn">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!--<script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js').catch(err => console.error(err));
    }
  </script>-->

  <script>
    // Reliable PWA detection – works in 2026
    function isRunningAsPWA() {
      // 1. display-mode: standalone (most reliable for Android/Chrome + iOS)
      if (window.matchMedia('(display-mode: standalone)').matches) return true;

      // 2. iOS Safari legacy flag
      if (navigator.standalone === true) return true;

      // 3. Fallback: check if launched from home screen (no browser UI)
      // This catches cases where matchMedia is not fully supported
      const isMinimalUI = window.innerWidth === screen.width && window.innerHeight === screen.height;
      const hasNoBrowserChrome = !window.location.search.includes('browser') && !navigator.userAgent.includes('Mobile Safari');

      return isMinimalUI && hasNoBrowserChrome;
    }

    const isPWA = isRunningAsPWA();

    if (isPWA) {
      // Launched from home screen → show full app, hide install screen
      document.getElementById('install-screen').classList.add('hidden');
      document.getElementById('app-content').style.display = 'block';
    } else {
      // Normal browser tab → show install screen, hide app
      document.getElementById('app-content').style.display = 'none';
      document.getElementById('install-screen').classList.remove('hidden');

      let deferredPrompt;

      window.addEventListener('beforeinstallprompt', e => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('installBtn').textContent = 'Instalar na Tela Inicial';
      });

      document.getElementById('installBtn').onclick = async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          console.log('Install outcome:', outcome);
          deferredPrompt = null;
          // Optional: hide button after prompt
          document.getElementById('installBtn').classList.add('hidden');
        } else {
          alert('Para instalar:\n\nAndroid/Chrome: use o menu do navegador → "Adicionar à tela inicial"\n\niPhone/Safari: use o botão Partilhar ⤴ → "Adicionar à Tela de Início"');
        }
      };

      // Show iOS guide if detected
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      if (isIOS) {
        document.getElementById('iosGuide').classList.remove('hidden');
        document.getElementById('installBtn').textContent = 'Ver instruções para iPhone';
      }
    }
  </script>
</body>
</html>